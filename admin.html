<script>

//// ---------------- SETTINGS ---------------- ////

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbynxK5255t3pAmsCHsQegf1L_pS4bTICU9PeJPUvobGxty1Ld1jYO103b6woWGd7yVFpQ/exec';
const PIN_HASH = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4";

//// ---------------- STATE ---------------- ////

let DB = [];

//// ---------------- DOM CACHE ---------------- ////

const loginScreen = document.getElementById('login-screen');
const errorBox = document.getElementById('error');
const loader = document.getElementById('loader');
const table = document.getElementById('data-table');
const tbody = document.getElementById('table-body');

const revenueEl = document.getElementById('revenue');
const totalCountEl = document.getElementById('total-count');
const soonCountEl = document.getElementById('soon-count');
const pageTitle = document.getElementById('page-title');
const searchInput = document.getElementById('search');

//// ---------------- LOGIN ---------------- ////

async function login() {

    const pin = document.getElementById('pin').value;
    const hash = await sha256(pin);

    if(hash === PIN_HASH){
        loginScreen.style.display = "none";
        fetchData();
    } else {
        errorBox.style.display = "block";
    }
}

async function sha256(str){
    const buf = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash))
        .map(b=>b.toString(16).padStart(2,'0'))
        .join('');
}

//// ---------------- FETCH ---------------- ////

async function fetchData(){

    try{

        const res = await fetch(SCRIPT_URL);
        const data = await res.json();

        const rows = data.data.slice(1);

        DB = rows.map(r => ({
            date: r[0],
            name: r[1] || "",
            phone: r[2] || "",
            plan: r[3] || "",
            amount: parseInt(r[4]) || 0,
            days: parseInt(r[7]) || 0
        }));

        DB.sort((a,b)=> new Date(b.date) - new Date(a.date));

        initStats();
        render(DB);

        loader.style.display = "none";
        table.style.display = "table";

    } catch(err){

        loader.innerHTML = "âš  Failed to load data";

    }
}

//// ---------------- STATS ---------------- ////

function initStats(){

    const revenue = DB.reduce((s,i)=> s+i.amount,0);
    const soon = DB.filter(i=> i.days>=0 && i.days<=7).length;

    revenueEl.innerText = revenue.toLocaleString();
    totalCountEl.innerText = DB.length;
    soonCountEl.innerText = soon;
}

//// ---------------- FILTER ---------------- ////

function filter(type,btn){

    document.querySelectorAll('.nav-item')
        .forEach(el=>el.classList.remove('active'));

    btn.classList.add('active');

    let list = DB;

    if(type==="active"){
        list = DB.filter(i=>i.days>=0);
        pageTitle.innerText="Active Members";
    }

    else if(type==="soon"){
        list = DB.filter(i=>i.days>=0 && i.days<=7);
        pageTitle.innerText="Expiring Soon";
    }

    else if(type==="expired"){
        list = DB.filter(i=>i.days<0);
        pageTitle.innerText="Expired Members";
    }

    else{
        pageTitle.innerText="All Records";
    }

    render(list);
}

//// ---------------- RENDER ---------------- ////

function render(list){

    if(!list.length){
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:30px">No records</td></tr>`;
        return;
    }

    let html = "";

    list.forEach(item=>{

        let badge = `<span class="badge b-active">${item.days} Days Left</span>`;

        if(item.days<=7)
            badge = `<span class="badge b-expiring">${item.days} Days Left</span>`;

        if(item.days<0)
            badge = `<span class="badge b-expired">Expired</span>`;

        const dateStr = new Date(item.date).toLocaleDateString('en-IN');

        let wa = `<span style="opacity:0.3"><i class="fas fa-whatsapp"></i></span>`;

        if(item.phone){
            const msg=`Hello ${item.name}, your gym membership status: ${item.days} Days Left.`;
            wa=`<a href="https://wa.me/91${item.phone}?text=${encodeURIComponent(msg)}" target="_blank" style="color:#25d366;font-size:1.1rem"><i class="fab fa-whatsapp"></i></a>`;
        }

        html += `
        <tr>
            <td style="color:#888">${dateStr}</td>
            <td style="font-weight:600;color:#fff">${item.name}</td>
            <td>${item.phone||"-"}</td>
            <td>${item.plan}</td>
            <td>${badge}</td>
            <td>${wa}</td>
        </tr>`;
    });

    tbody.innerHTML = html;
}

//// ---------------- SEARCH (DEBOUNCED) ---------------- ////

let searchTimeout;

searchInput.addEventListener("input",()=>{

    clearTimeout(searchTimeout);

    searchTimeout = setTimeout(()=>{

        const term = searchInput.value.toLowerCase();

        const filtered = DB.filter(i=>
            i.name.toLowerCase().includes(term) ||
            (i.phone && i.phone.includes(term))
        );

        render(filtered);

    },200);
});

</script>
