<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Chandhu-Fitness</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { 
            --primary: #ff3b3b; 
            --dark: #090909; 
            --panel: #121212;
            --border: #222;
            --text: #e0e0e0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background: var(--dark); color: var(--text); 
            font-family: 'Montserrat', sans-serif;
            height: 100vh; display: flex; overflow: hidden;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; inset: 0; background: #000; z-index: 999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .pin-box {
            background: #1a1a1a; padding: 30px; border-radius: 12px; border: 1px solid var(--border);
            text-align: center; width: 300px;
        }
        input[type="password"] {
            width: 100%; padding: 12px; margin: 15px 0; background: #000; 
            border: 1px solid #333; color: white; text-align: center; font-size: 1.2rem; letter-spacing: 5px;
            border-radius: 6px;
        }
        .btn {
            width: 100%; padding: 12px; background: var(--primary); color: white; border: none; 
            font-weight: bold; cursor: pointer; border-radius: 6px; font-family: 'Oswald', sans-serif;
            transition: 0.2s;
        }
        .btn:hover { opacity: 0.9; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; background: #050505; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px;
        }
        .brand {
            font-family: 'Oswald', sans-serif; font-size: 1.5rem; color: white; margin-bottom: 40px;
            text-align: center; letter-spacing: 1px;
        }
        .brand span { color: var(--primary); }
        
        .nav-item {
            padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; cursor: pointer;
            color: #888; transition: 0.2s; font-size: 0.9rem; font-weight: 500;
            display: flex; align-items: center; gap: 12px;
        }
        .nav-item:hover, .nav-item.active {
            background: var(--primary); color: white;
        }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; display: flex; flex-direction: column; background: var(--panel); }
        
        .top-bar {
            padding: 20px 30px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; background: rgba(18,18,18,0.95);
        }
        .search-box {
            background: #000; border: 1px solid #333; padding: 10px 15px; 
            color: white; border-radius: 6px; width: 300px; font-family: inherit;
        }

        /* STATS */
        .stats-row {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 30px;
        }
        .stat-card {
            background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid var(--border);
        }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: white; font-family: 'Oswald', sans-serif; }
        .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-top: 5px; }

        /* TABLE */
        .table-wrapper {
            flex: 1; overflow: auto; padding: 0 30px 30px 30px;
        }
        table { width: 100%; border-collapse: collapse; }
        thead { position: sticky; top: 0; background: var(--panel); z-index: 10; }
        th { text-align: left; padding: 15px; color: #666; font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: #ccc; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .b-active { background: rgba(0,255,136,0.15); color: #00ff88; }
        .b-expiring { background: rgba(255,183,0,0.15); color: #ffb700; }
        .b-expired { background: rgba(255,59,59,0.15); color: #ff3b3b; }

        @media(max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; flex-direction: row; overflow-x: auto; padding: 10px; height: auto; }
            .nav-item { white-space: nowrap; font-size: 0.8rem; padding: 8px 12px; }
            .brand { display: none; }
            .stats-row { grid-template-columns: 1fr; padding: 20px; }
            .search-box { width: 100%; }
            .table-wrapper { padding: 0 20px 20px; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="pin-box">
            <h2 style="font-family:'Oswald',sans-serif; margin-bottom:10px;">ADMIN ACCESS</h2>
            <input type="password" id="pin" placeholder="PIN" maxlength="4">
            <button class="btn" onclick="login()">UNLOCK</button>
            <p id="error" style="color:#ff3b3b; margin-top:10px; font-size:0.8rem; display:none;">Incorrect PIN</p>
        </div>
    </div>

    <div class="sidebar">
        <div class="brand">CHANDHU<span>FITNESS</span></div>
        <div class="nav-item active" onclick="filter('all', this)"><i class="fas fa-list"></i> All Records</div>
        <div class="nav-item" onclick="filter('active', this)"><i class="fas fa-check"></i> Active Members</div>
        <div class="nav-item" onclick="filter('soon', this)"><i class="fas fa-exclamation-triangle"></i> Expiring Soon</div>
        <div class="nav-item" onclick="filter('expired', this)"><i class="fas fa-times"></i> Expired</div>
        <div class="nav-item" onclick="location.reload()" style="margin-top:auto; color:#666;"><i class="fas fa-sync"></i> Refresh Data</div>
    </div>

    <div class="main">
        <div class="top-bar">
            <h2 style="font-family:'Oswald',sans-serif" id="page-title">Dashboard</h2>
            <input type="text" class="search-box" id="search" placeholder="Search name or phone..." onkeyup="searchTable()">
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-val" style="color:var(--primary)">â‚¹<span id="revenue">0</span></div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="total-count">0</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" style="color:#ffb700" id="soon-count">0</div>
                <div class="stat-label">Expiring Soon</div>
            </div>
        </div>

        <div class="table-wrapper">
            <div id="loader" style="text-align:center; padding:40px; color:#666;">
                <i class="fas fa-circle-notch fa-spin"></i> Loading Data...
            </div>
            <table id="data-table" style="display:none;">
                <thead>
                    <tr>
                        <th>Joined</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Plan</th>
                        <th>Status</th>
                        <th>Notify</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- SETTINGS ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbynxK5255t3pAmsCHsQegf1L_pS4bTICU9PeJPUvobGxty1Ld1jYO103b6woWGd7yVFpQ/exec'; 
        const PIN_HASH = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4"; // PIN: 1234

        let db = []; // Master Data

        // LOGIN
        async function login() {
            const val = document.getElementById('pin').value;
            const hash = await sha256(val);
            if(hash === PIN_HASH) {
                document.getElementById('login-screen').style.display = 'none';
                fetchData();
            } else {
                document.getElementById('error').style.display = 'block';
            }
        }

        async function sha256(str) {
            const buf = new TextEncoder().encode(str);
            const hash = await crypto.subtle.digest('SHA-256', buf);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
        }

        // FETCH
        function fetchData() {
            fetch(SCRIPT_URL)
                .then(r => r.json())
                .then(d => {
                    // Process Raw Data
                    const rows = d.data.slice(1); // Skip Header
                    
                    // Map to clean objects
                    db = rows.map(r => ({
                        date: r[0],
                        name: r[1],
                        phone: r[2],
                        plan: r[3],
                        amount: parseInt(r[4]) || 0,
                        days: parseInt(r[7]) || 0 // Default to 0 if formula missing
                    }));

                    // Sort: Latest First
                    db.sort((a,b) => new Date(b.date) - new Date(a.date));

                    initStats();
                    render(db);
                    
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('data-table').style.display = 'table';
                });
        }

        // STATS
        function initStats() {
            const revenue = db.reduce((sum, item) => sum + item.amount, 0);
            const soon = db.filter(i => i.days >= 0 && i.days <= 7).length;
            
            document.getElementById('revenue').innerText = revenue.toLocaleString();
            document.getElementById('total-count').innerText = db.length;
            document.getElementById('soon-count').innerText = soon;
        }

        // FILTER
        function filter(type, btn) {
            // Update UI
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');

            let list = [];
            const title = document.getElementById('page-title');

            if(type === 'all') { list = db; title.innerText = "All Records"; }
            if(type === 'active') { list = db.filter(i => i.days >= 0); title.innerText = "Active Members"; }
            if(type === 'soon') { list = db.filter(i => i.days >= 0 && i.days <= 7); title.innerText = "Expiring Soon"; }
            if(type === 'expired') { list = db.filter(i => i.days < 0); title.innerText = "Expired Members"; }

            render(list);
        }

        // RENDER
        function render(list) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if(list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px;">No records found</td></tr>`;
                return;
            }

            list.forEach(item => {
                let badge = `<span class="badge b-active">${item.days} Days Left</span>`;
                if(item.days <= 7) badge = `<span class="badge b-expiring">${item.days} Days Left</span>`;
                if(item.days < 0) badge = `<span class="badge b-expired">Expired</span>`;

                const dateStr = new Date(item.date).toLocaleDateString('en-IN');
                
                // WhatsApp Link
                let wa = `<span style="opacity:0.3"><i class="fas fa-whatsapp"></i></span>`;
                if(item.phone) {
                    const msg = `Hello ${item.name}, your gym membership status: ${item.days} Days Left.`;
                    wa = `<a href="https://wa.me/91${item.phone}?text=${encodeURIComponent(msg)}" target="_blank" style="color:#25d366; font-size:1.1rem"><i class="fab fa-whatsapp"></i></a>`;
                }

                const row = `
                    <tr>
                        <td style="color:#888">${dateStr}</td>
                        <td style="font-weight:600; color:#fff">${item.name}</td>
                        <td>${item.phone || '-'}</td>
                        <td>${item.plan}</td>
                        <td>${badge}</td>
                        <td>${wa}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // SEARCH
        function searchTable() {
            const term = document.getElementById('search').value.toLowerCase();
            const filtered = db.filter(i => 
                i.name.toLowerCase().includes(term) || 
                (i.phone && i.phone.toString().includes(term))
            );
            render(filtered);
        }
    </script>
</body>
</html>
